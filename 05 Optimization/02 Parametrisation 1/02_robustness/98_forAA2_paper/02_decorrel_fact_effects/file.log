/BATCH  
/COM,ANSYS RELEASE Release 19.2      BUILD 19.2      UP20180808       01:50:56
/COM,ANSYS RELEASE Release 19.2      BUILD 19.2      UP20180808       01:50:56
! --- Frequency resolution and mesh sizes   
C***,Frequency resolution and mesh sizes
*USE,GET_MESH_SIZE,Speed_Sound,Freq_high_MA,flowres,mySMSfact   
! --- Create geometry and calculate volume  
C***,FOLDHERE   
/PREP7  
! Create room via parameters input  
K,1,0,0,0   
K,2,xA,yA,zA
K,3,xB,yB,zB
K,4,xC,yC,zC
K,5,xP1,yP1,zP1 
K,6,xP2,yP2,zP2 
K,7,xP3,yP3,zP3 
K,8,xP4,yP4,zP4 
V,1,2,5,3,4,7,8,6   
NUMCMP,VOLU       ! Compress volume numbers 
ALLSEL  
*GET,roomVolNo,VOLU,0,NUM,MAX  ! Get room volume number 
!IGESOUT, 01_input_files\OD6, IGES  
!*IF,1,EQ,2,THEN
! --- Create sample 
*SET,useTBPERF , 1  
*ULIB,sample_macpath,mac
/PMACRO 
*USE,MAKE_SAMPLE,Lsx,Lsy,Csx,Csy,ds,theta_s,roomVolNo,centerSample,sampleSurface
*ULIB   
*SET,useTBPERF , 0  
*GET,sampVolNo,VOLU,0,NUM,MIN  ! Get sample volume number   
VDELE,sampVolNo 
ALLSEL  
! Get final air volume  
C***,Get final air volume   
ALLSEL  
VSEL,ALL
VSEL,U,VOLU,,SampleVolume   ! Deselect the sample   
VSUM,FINE    ! Calculate geometry statistics of selected volumes
*GET,V,VOLU,0,VOLU  ! Get effective air 
CM,airVolumeCM,VOLU  ! Make component out of this volume
ALLSEL  
ASLV,S  
ASUM,FINE    ! Calculate geometry statistics of selected areas  
*GET,SurfArea,AREA,0,AREA  ! Get total surface area 
LSUM,FINE    ! Calculate geometry statistics of selected lines  
*GET,EdgeLength,LINE,0,LENG  ! Get total edge length
C***,UNFOLDHERE 
! --- Define material properties and mesh   
C***,Define material properties and mesh
*ULIB,RTana_macpath,mac 
/PMACRO 
*USE,CREATE_MESH,Density,Speed_Sound,Ref_Pressure,samplePresent,useTBPERF,flowres,Mesh_size,SampleMesh_size,sampleSurface   
! Before detaching nodes and elements, prepare necessary components 
CMSEL,S,sampleTopArea   
NSLA,S,1  ! Select ALL corresponding nodes (also along edges & at corners)  
CM,sampleTopNodes,NODE  
LSLA,S    ! Select lines linked to sample top surface area  
NSLL,S,1  ! Select corresponding nodes  
CM,sampleTopEdgeNodes,NODE  
ALLSEL  
! EXPORT IMAGE  
/SHOW,PNG,,0
PNGR , ORIENT, HORIZ
PNGR , Color, 2 
PNGR , TMOD, 1  
ALLSEL  
CSYS,0  
DSYS,0  
/VUP, ALL, Z  ! Specifies the global Cartesian coordinate system reference orientation (Y = default).   
/VIEW,ALL,1,1,1 
/AUTO   
EPLOT   
/GFILE,800, 
/SHOW,CLOSE 
/DEVICE,VECTOR,0
/RENAME,STRCAT(jbname,'000'),png,,STRCAT(prefix_out,'mesh'),png 
ALLSEL  
MODMSH,DETACH   
C***,Find nodes corresponding to source(s)  
*ULIB,RTanav3_macpath,mac   
/PMACRO 
*USE,S_NODES,Mesh_size,sourcesPos,prefix_out,mindist_sw 
!*if,1,eq,2,then
! Derive number of modes necessary  ~ref: Research Journal ZAPPA week41 Tuesday 
*USE,GET_NMODES,Freq_high_MA,Freq_low_MA,Speed_Sound,SurfArea,EdgeLength
*IF,quickTest,EQ,1,THEN 
*SET,nmodes , 10
*ENDIF  
!*IF,1,EQ,2,THEN  ! DEBUGGING   
! --- Solve Modal Analysis  
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
C***,FOLDHERE   
/SOLU   
FINISH  
/SOL
ANTYPE,MODAL  ! Modal analysis  
! Choose modal solver -- NO DAMPING 
MODOPT,LANB,nmodes,Freq_low_MA,Freq_high_MA,,OFF  ! Normalize the mode shapes to the mass matrix
! Expand solution for post-processing   
!MXPAND,ALL,,,YES   
MXPAND,ALL,,,NO,,NO 
OUTRES,ALL,NONE  ! Write NOTHING to the database ...
OUTRES,NSOL,ALL    ! ... else than the nodal solutions. 
SAVE
SOLVE    ! Calculate the modal response 
FINISH  
C***,UNFOLDHERE 
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
! Post-processing and export
C***,FOLDHERE   
/post1  
! Control amount of data to be fetched from database
INRES,NSOL  
! Get final number of sets (number of eigenfrequencies in range)
*GET,neig,ACTIVE,0,SET,NSET 
*SET,Fname , STRCAT(prefix_out,'paramsMA')  
*CFOPEN,Fname,txt   ! Define output file name   
*VWRITE,V,SurfArea,Mesh_size,Speed_Sound,Density  ! Write physical parameters   
(F,6x,F,6x,F,6x,F,6x,F) 
*VWRITE,Csx,Csy,Lsx,Lsy,ds   ! Write sample parameters  
(F,6x,F,6x,F,6x,F,6x,F) 
*DO,ii,1,Ns 
*SET,s1 , s_pos(ii:ii,1:1)  
*SET,s2 , s_pos(ii:ii,2:2)  
*SET,s3 , s_pos(ii:ii,3:3)  
*VWRITE,s1,s2,s3 ! Write true source positions  
(F,6x,F,6x,F)   
*ENDDO  
*CFCLOS 
! Initiate results arrays   
*DEL,freqs  
*DEL,ps 
*DIM,freqs,ARRAY,neig    ! Analysis frequency (real/imag part)  
*DO,ii,1,Ns 
*DEL,ps_%CHRVAL(ii)%
*DIM,ps_%CHRVAL(ii)%,ARRAY,neig  ! Pressures at sources (real/imag part)
*ENDDO  
! Loop on each solved step (each analysis frequency)
*DO,ii,1,neig   
*IF,ii,EQ,1,then  ! Open the solution (sub)step 
SET,FIRST   
*ELSE   
SET,NEXT
*ENDIF  
! Get the data  
*GET,freqs(ii:ii),ACTIVE,0,SET,FREQ      ! Get the eigenfrequency   
*DO,jj,1,Ns 
*GET,ps_%CHRVAL(jj)%(ii:ii),NODE,Mic_Node%CHRVAL(jj)%,PRES  
*ENDDO  
*ENDDO  
*SET,Fname , STRCAT(prefix_out,'freqsMA')   
*MWRITE,freqs,Fname,txt,,IJK,neig   
(F) 
*DO,ii,1,Ns 
*SET,Fname , STRCAT(prefix_out,STRCAT('psMA_',CHRVAL(ii)))  
*MWRITE,ps_%CHRVAL(ii)%,Fname,txt,,IJK,neig 
(F) 
*ENDDO  
FINISH  
! Export mode shapes on sample surface  
*ULIB,RTanav3_macpath,mac   ! Use macro library 
/PMACRO 
*USE,EXPORT_MS_SAMPLE,prefix_out,neig,nNodExportMax 
*ULIB   
! Generate end of run flag file 
*CFOPEN,STRCAT(prefix_out,'endofrun_flag'),txt  
*VWRITE,'FLAGFLAGFLAG'  
(A) 
*CFCLOS 
C***,UNFOLDHERE 
